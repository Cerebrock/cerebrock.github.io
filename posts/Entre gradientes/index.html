<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>entre gradientes | Musical Neuron</title>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://cerebrock.github.io/posts/Entre%20gradientes/">
<!--[if lt IE 9]><script src="../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><script src="https://cdn.plot.ly/plotly-latest.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script>requirejs.config({paths: { 'plotly': ['https://cdn.plot.ly/plotly-latest.min']},});if(!window.Plotly) {{require(['plotly'],function(plotly) {window.Plotly=plotly;});}}</script><meta name="author" content="MG">
<link rel="prev" href="../Vocational%20Data%20Science/" title="Modern...ish Vocational Testing" type="text/html">
<meta property="og:site_name" content="Musical Neuron">
<meta property="og:title" content="entre gradientes">
<meta property="og:url" content="https://cerebrock.github.io/posts/Entre%20gradientes/">
<meta property="og:description" content="Solving a large scale constrained non linear program for operations research with gradient descentÂ¶







Task surveying
Problem Formulation
Introductory example
Scipy 
CVXPY
Solution with gradient d">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-11-14T00:00:00-03:00">
<meta property="article:tag" content="business">
<meta property="article:tag" content="math">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
</head>
<body>
    <a href="#page-content" class="sr-only sr-only-focusable">Skip to main content</a>
    
    <section class="social"><ul>
<li><a href="../../index.html" title="Inicio"><i class="fa fa-home"></i></a></li>
            <li><a href="../../categories/index.html" title="Tags"><i class="fa fa-tags"></i></a></li>
            <li><a href="../../pages/about/" title="Inicio"><i class="fa fa-user"></i></a></li>
            <li><a href="https://github.com/cerebrock" title="Github"><i class="fab fa-github"></i></a></li>
            <li><a href="../../archive/" title="Archives"><i class="fa fa-folder-open"></i></a></li>
            <li><a href="https://www.linkedin.com/in/matias-grinberg" title="About me"><i class="fab fa-linkedin"></i></a></li>
            <li><a href="https://www.instagram.com/cerebrock/" title="Instagram"><i class="fab fa-instagram"></i></a></li>
            <li><a href="https://twitter.com/Mati_G_" title="Twitter"><i class="fab fa-twitter"></i></a></li>
    
    

        </ul></section><section class="page-content"><div class="content" rel="main">
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="../Entre%20gradientes/" class="u-url">entre gradientes</a></h1>

        <div class="metadata">
            <p class="dateline"><a href="../Entre%20gradientes/" rel="bookmark"><i class="fa fa-clock"></i> <time class="published dt-published" datetime="2019-11-14T00:00:00-03:00" itemprop="datePublished" title="14-11-2019 ">14-11-2019 </time></a></p>
            <p class="byline author vcard"> <i class="fa fa-user"></i> <span class="byline-name fn" itemprop="author">
                    MG
            </span></p>
                <p class="commentline"><i class="far fa-comment"></i>            <a href="../Entre%20gradientes/#disqus_thread" data-disqus-identifier="cache/posts/CVX.html">Comments</a>


                    </p>
<p class="sourceline"><a href="../Entre%20gradientes/index.ipynb" class="sourcelink"><i class="fa fa-file-code"></i> Source</a></p>

            
                <div class="tags">
<h3 class="metadata-title">
<i class="fa fa-tags"></i> Tags:</h3>
        <ul itemprop="keywords" class="tags-ul">
<li><a class="tag p-category" href="../../categories/business/" rel="tag">business</a></li>
            <li><a class="tag p-category" href="../../categories/math/" rel="tag">math</a></li>
        </ul>
</div>

        </div>
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Solving-a-large-scale-constrained-non-linear-program-for-operations-research-with-gradient-descent">Solving a large scale constrained non linear program for operations research with gradient descent<a class="anchor-link" href="../Entre%20gradientes/#Solving-a-large-scale-constrained-non-linear-program-for-operations-research-with-gradient-descent">Â¶</a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Task surveying</li>
<li>Problem Formulation</li>
<li>Introductory example</li>
<li>Scipy </li>
<li>CVXPY</li>
<li>Solution with gradient descent</li>
<li>Alternative geometric approach</li>
<li>Extra comments on deployment:<ul>
<li>Docker</li>
<li>Cloud Services</li>
<li>Flask API with GPU support</li>
<li>MSSQL Server</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Project-surveing">Project surveing<a class="anchor-link" href="../Entre%20gradientes/#Project-surveing">Â¶</a>
</h4>
<p>When solving data science tasks for education purposes or in online challenges (ej. Kaggle), the problem objective is given explicitely, and many times even with adequate metrics. In industry that is not always the case, as it is frequent that clients do not bring forward a directly tractable formulation of the problem, or a <em>Key Performance Indicator</em>. The optimization objective may not be trivial, so it is on the data scientist to define a formal statement. The task addressed is to distribute the stock for the next period, subject to different sets of constrains and avoiding large varations in a given vendor. Taking this inventory allocation case as example, we would not expect the user to know that the adequate L-norm for his allocation strategy was L-$\infty$. More even, the hierarchy of groupings given by the user may have been coded as high dimensional tensor, tree, hypergraph, or flattened vector. Let alone the strategy for the solution.</p>
<p>A couple of initial meetings were required to design the interface, delimit the convinient funcionalities, and planning the deployment infraestructure. As I managed the develompent completely, I had to take into account aspects like client relationship, cost estimations, validation, and deployment. Coming from a more research oriented career, there are points to keep an eye on as for example, be very wary about promising dates and aim to overestimate ðŸ˜…. Along the way, we met for the team of analysts to audit the solution, and modify the scope and specs.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Problem-statement">Problem statement<a class="anchor-link" href="../Entre%20gradientes/#Problem-statement">Â¶</a>
</h5>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In abstract, optimization in this context is the process of choosing the best possible vector $\in R^n$ from a set. In this way it encompasses many ways of decision making, and so the reason for its ubiquitous relevance. The general formulation is:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
$$\begin{aligned}
&amp; \underset{x}{\text{minimize}}
&amp; &amp; f(x) \\
&amp; \text{subject to}
&amp; &amp; f_i(x) \leq b_i, \; i = 1, \ldots, m.
\end{aligned}$$
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In our case, the problem consists on allocating certain inventory to their possible outlets minimizing the variation with respect to the previous period, and while satisfying arbitrary constrains defined on hierarchical and overlapping categories. A stock of a $p \in \mathbb{N^i}$ products has to be allocated to $s \in \mathbb{N^j}$ outlets. Equality and inequality restrictions intend to modulate sales in different areas, allow compliance to commercial agreements, and respond to diverse business needs. Both $p$ and $s$ are classified in multiple hierarchical levels, e.g. : <em>channel, area, group, delivery route...</em> for $s$; <em>family, product, flavor...</em> for $p$. 
    One possibility for the formulation is to organize this levels into a  but forcing symetry would conveys extra memory consumption assigning redundant space (allocating a quantity of each product for each outlet when not all products are sold at all outlets). Therefore a vector is constructed as $\textbf{q} = (s_0p_0, ..., s_ip_j)$, $\textbf{q} \in \mathbb{R}^{i \times j}$ where $p_is_j$ corresponds to the quantity of product $i$ in outlet $j$, and excluding the elements $i,j$ that are not applicable for the period distribution. Continuous relaxation of the $q$ vector is allowed for faster computation. The optimization problem is formulated as:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If all $f_i(x)$ fulfil linearity conditions, $f_i(Î±x + Î²y) = Î±f_i(x) + Î²f_i(y)$, then the problem corresponds to a <em>linear program</em>. A more general class of problems consist of all that comply $f_i(Î±x + Î²y) â‰¤ Î±f_i(x) + Î²f_i(y)$ given $Î±, Î² \in [0,1], Î± + Î² = 1$, corresponding to the domain of <em>convex problems</em>. Finally, with $x \in \mathbb{Z}$, a <em>Mixed Integer Convex Non-Linear Program</em> can be defined.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
$$\begin{aligned}
\underset{q}{\text{minimize }}
&amp; 
| ( \mathbf{q} - \mathbf{q_{0}} ) \oslash  \mathbf{q_{0}} |^{\infty}
\\ \text{subject to: } 
&amp; \textbf{R}\textbf{q} = \textbf{b} \\ 
&amp; \textbf{M}\textbf{q} \leq \textbf{d}
\end{aligned}$$
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Where each row $r$ in $R \in \{0,1\}^{i \times j}$ represents a restriction and is defined as $r_i = 1$ if the corresponding element in $\textbf{q}$ is in the subset to which the restriction applies. The symbol $\oslash$ corresponds to element-wise (or Hadamard) division.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<!-- TEASER_END -->
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The article is not at all finished. Much pruning, writting, and editing to do. Proceed at your own risk!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Solution-1">Solution 1<a class="anchor-link" href="../Entre%20gradientes/#Solution-1">Â¶</a>
</h5>
<p>The general idea is to calculate the contribution of each variable $q_{ij}$ to each restriction, and average that quantity over all restrictions to apply a gradient descent $\Delta$ on vector $q$.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#This solution runs in $\mathcal{O} ...$ time, converging to a value that minimizes a combination of $\ell \text{-} 2$ and $\ell\text{-}\infty$ norms. </span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
$$\text{Init } \textbf{q*} := q_0 $$$$\text{Repeat until convergence:}$$$$\textbf{e} = \textbf{b} \oslash \textbf{R} \cdot \textbf{q*}$$$$\textbf{R*} = diag( \textbf{e}) \cdot \textbf{R}$$$$\Delta_{j} = \frac{1}{i}\sum_{\{i: R*_{ij} \neq 0\}} \textbf{R*}_{ij}$$$$\textbf{q*} = \textbf{q} \odot \Delta$$
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Solution-2">Solution 2<a class="anchor-link" href="../Entre%20gradientes/#Solution-2">Â¶</a>
</h5>
<p>This second solution consists on using a weighted inner product given by matrix $\textbf{W}$, that makes the norm proportional to the previous vector $\textbf{q}_0$. A first solution to the $\textbf{R}\textbf{q} = \textbf{b}$ system is calculated to proyect the variety of solutions to a subspace. Then the previous vector $q_0$ is proyected to this subspace using as inner product the matrix $\textbf{W}$ the so to find the closest vector than</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
$$\textbf{W} = diag(\textbf{q}_0)$$$$\textbf{s} =  \textit{Least squares}[\textbf{R}\textbf{q} = \textbf{b}]$$$$\textbf{q*} = \textbf{q}_0 - \textbf{s}$$$$\textbf{o} = \textit{Orth}[(R \cdot W)^T]$$$$\textbf{v} = \textbf{W} \cdot o$$$$\textbf{x} = \textbf{o} - \textbf{v} \cdot (v^T \cdot \textbf{W}^{-2} \cdot \textbf{o})$$$$\textbf{q} = x + s$$
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For least squares, LSQR algorithm is used (c), and the orthogonal basis $o$ is computed using singular value decomposition.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">sparse</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span> <span class="k">as</span> <span class="nn">linalg</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="k">import</span> <span class="n">csr_matrix</span><span class="p">,</span> <span class="n">save_npz</span><span class="p">,</span> <span class="n">load_npz</span><span class="p">,</span> <span class="n">diags</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="k">import</span> <span class="n">lsqr</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="k">import</span> <span class="n">orth</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pyodbc</span> 
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="k">import</span> <span class="n">csr_matrix</span>

<span class="c1"># Extras para visualizar</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="k">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="o">%</span><span class="k">matplotlib</span> notebook
<span class="n">CSS</span> <span class="o">=</span> <span class="s2">".output {flex-direction: row;}"</span>
<span class="n">HTML</span><span class="p">(</span><span class="s1">'&lt;style&gt;</span><span class="si">{}</span><span class="s1">&lt;/style&gt;'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CSS</span><span class="p">))</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Warnings que no afectan. Runtime es por fila en A que es = 0</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span><span class="n">category</span><span class="o">=</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span><span class="n">category</span><span class="o">=</span> <span class="ne">FutureWarning</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span><span class="n">category</span><span class="o">=</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">check_sol</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">th1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">th2</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
    <span class="sd">"""Muestra un resumen informativo del resultado</span>
<span class="sd">    A: Matriz binaria de restricciones</span>
<span class="sd">    q: vector a optimizar, en ppio es WarmStart</span>
<span class="sd">    b: vector con los objetivos de las restricciones (incluye ineqs)</span>
<span class="sd">    th: se enumera n &gt; th1 y n &gt; th2"""</span>
    
    <span class="n">Q</span><span class="p">[</span><span class="s1">'Dif'</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="s1">'Z'</span><span class="p">]</span> <span class="o">/</span> <span class="n">Q</span><span class="p">[</span><span class="s1">'WarmStart'</span><span class="p">]</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="s1">'Dif'</span><span class="p">],</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> 
            <span class="n">Q</span><span class="p">[</span><span class="s1">'Dif'</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> 
            <span class="n">Q</span><span class="p">[</span><span class="s1">'Dif'</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="n">Q</span><span class="p">[</span><span class="s1">'Dif'</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>   
            <span class="n">Q</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Q</span><span class="p">[</span><span class="s1">'Dif'</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">th1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">Q</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Q</span><span class="p">[</span><span class="s1">'Dif'</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">th2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
            <span class="n">Q</span><span class="p">[</span><span class="n">Q</span><span class="p">[</span><span class="s1">'Z'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">q</span> <span class="o">-</span> <span class="n">b</span><span class="p">))</span>
    
    <span class="n">names</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'Norma, Max, Min, Media, Mayores a </span><span class="si">{th1:.2f}</span><span class="s1">'</span> \
            <span class="n">f</span><span class="s1">', Mayores a </span><span class="si">{th2:.2f}</span><span class="s1">, Negativos, Norm Aq-b'</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">data</span><span class="p">)}</span>
    
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="s1">'Dif'</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">norm_hist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">'Min'</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">'Max'</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>  
        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">"[\d\-]+\.*0*[.1-9]{0,2}"</span><span class="p">,</span> 
                <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">solve_nras</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">idx_ineqs</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">d_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">q</span><span class="p">))</span>
        <span class="n">idx_ineqs_ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">idx_ineqs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">p</span><span class="p">[</span><span class="n">idx_ineqs_ok</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">A_</span><span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span><span class="n">A_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">A_</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))))</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">P</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">q</span><span class="p">))[[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idx_ineqs_ok</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">'</span><span class="se">\t</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;=</span> <span class="n">d_</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">d_</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">d_</span> <span class="o">&lt;</span> <span class="n">precision</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">q</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">check_sol</span><span class="p">(</span><span class="n">A</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">th1</span><span class="o">=</span><span class="mf">0.60</span><span class="p">,</span> <span class="n">th2</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">dif</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">q0</span><span class="p">)</span><span class="o">/</span><span class="n">q0</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">q</span> <span class="o">-</span> <span class="n">b</span><span class="p">),</span> <span class="n">dif</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">dif</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'Norma q-q0, Norma Aq-b, Max, Min'</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">data</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">show</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">norm_hist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s1">'Max'</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">'Min'</span><span class="p">]]))</span> <span class="o">+</span> <span class="mf">0.1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">)</span>  
        <span class="k">if</span> <span class="n">ylim</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">ylim</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">"[\d\-]+\.*0*[.1-9]{0,2}"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">show</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">solve_rel</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">idx_ineqs</span><span class="p">):</span>
    <span class="sd">"""En esta soluciÃ³n, se encuentra el vector mÃ¡s cercano a q que cumple con las restricciones,</span>
<span class="sd">    usando como producto interno una matriz con el inverso de q en la diagonal. </span>
<span class="sd">    Resulta en diferencias relativas al valor correspondiente inicial de q."""</span>
    
    <span class="c1">#indices de igualdades</span>
    <span class="n">eqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idx_ineqs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
    <span class="c1">#resultados actuales</span>
    <span class="n">b_</span> <span class="o">=</span> <span class="n">A</span> <span class="o">@</span> <span class="n">q</span>
    <span class="c1"># Se les asigna a las inecuaciones incumplidas el valor maximo permitido</span>
    <span class="n">idx_ineqs_ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="n">b_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">idx_ineqs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">b</span><span class="p">[</span><span class="n">idx_ineqs_ok</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_</span><span class="p">[</span><span class="n">idx_ineqs_ok</span><span class="p">]</span>
    
    <span class="c1">#matrix diagonal (sparse)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">diags</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="c1">#least squares</span>
    <span class="n">sol</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">lsqr</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="c1">#de var a subesp</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-</span> <span class="n">sol</span>
    <span class="c1">#base ortogonal</span>
    <span class="n">ort</span> <span class="o">=</span> <span class="n">orth</span><span class="p">((</span><span class="n">A</span> <span class="o">@</span> <span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">todense</span><span class="p">())</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">W</span> <span class="o">@</span> <span class="n">ort</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">o</span> <span class="o">-</span> <span class="n">base</span> <span class="o">@</span> <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">o</span><span class="p">))</span>
    <span class="n">q_</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">sol</span>
    <span class="k">return</span> <span class="n">q_</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">solve_cvx</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">idx_ineqs</span><span class="p">,</span> <span class="n">solver</span> <span class="o">=</span> <span class="s1">'SUPERSCS'</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-09</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nonneg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#warm start </span>
    <span class="n">q1</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">x</span>

    <span class="n">constrains</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_ineqs</span><span class="p">:</span>
            <span class="n">constrain</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q1</span><span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">constrain</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q1</span><span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>        
        <span class="n">constrains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constrain</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Constrains loaded.'</span><span class="p">)</span>
    
    <span class="n">obj</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q1</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1">#obj = cp.Minimize(cp.norm(cp.kl_div(x, q1)))# - cp.sum(q1)))</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">constrains</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Problem made."</span><span class="p">)</span>

    <span class="c1"># liberar memoria</span>
    <span class="k">del</span> <span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">b</span>

    <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">'OSQP'</span><span class="p">:</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iters</span><span class="p">,</span> <span class="n">linsys_solver</span><span class="o">=</span><span class="s1">'mkl pardiso'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">'SCS'</span> <span class="ow">in</span> <span class="n">solver</span><span class="p">:</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="n">max_iters</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Problem solved."</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">q1</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sol</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [47]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">def</span> <span class="nf">solve_lstsq</span><span class="p">():</span>
    <span class="n">b</span><span class="p">[</span><span class="n">idx_ineqs</span><span class="p">[(</span><span class="n">A</span> <span class="o">@</span> <span class="n">x</span><span class="p">)[</span><span class="n">idx_ineqs</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="p">[</span><span class="n">idx_ineqs</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">x</span><span class="p">)[</span><span class="n">idx_ineqs</span><span class="p">[(</span><span class="n">A</span> <span class="o">@</span> <span class="n">x</span><span class="p">)[</span><span class="n">idx_ineqs</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="p">[</span><span class="n">idx_ineqs</span><span class="p">]]]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">todense</span><span class="p">(),</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">write_sol</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">validar</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Wall time: 0 ns
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [187]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">perturbar</span><span class="p">(</span><span class="n">ineq</span><span class="o">=</span><span class="mi">25000000</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">TMP_PATH</span><span class="o">+</span> <span class="s1">'b.gz'</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float32'</span><span class="p">)</span>
    <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ineq</span>
<span class="c1">#    d = np.random.uniform(0.8, 1, size=b.shape[0])</span>
<span class="c1">#    b *= d</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">TMP_PATH</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">'\b.gz'</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Diferencias con objetivos,'</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">q</span> <span class="o">-</span> <span class="n">b</span><span class="p">)[:</span><span class="mi">10</span><span class="p">],</span> 
          <span class="s1">'Resultados totales,'</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">q</span><span class="p">)[:</span><span class="mi">10</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [85]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">solve_nras</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">idx_ineqs</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">"""Devuelve (b - (A @ q)) """</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">d_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">q</span><span class="p">))</span>
        <span class="n">idx_ineqs_ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">idx_ineqs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">p</span><span class="p">[</span><span class="n">idx_ineqs_ok</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">A_</span><span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span><span class="n">A_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">A_</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))))</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">P</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">q</span><span class="p">))[[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idx_ineqs_ok</span><span class="p">]])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">'</span><span class="se">\t</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;=</span> <span class="n">d_</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">d_</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">d_</span> <span class="o">&lt;</span> <span class="n">precision</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">q</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [66]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">solve_ultra</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">idx_ineqs</span><span class="p">,</span> <span class="n">th_max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">th_min</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_coef</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_coef</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">"""Resuelve resolviendo mediante norma 2 y luego iterando hacia norma inf"""</span>
    <span class="c1">#indices de igualdades</span>
    <span class="n">eqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idx_ineqs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
    <span class="c1">#resultados actuales</span>
    <span class="n">b_</span> <span class="o">=</span> <span class="n">A</span> <span class="o">@</span> <span class="n">q0</span>
    <span class="c1"># Se les asigna a las inecuaciones incumplidas el valor maximo permitido</span>
    <span class="n">idx_ineqs_ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="n">b_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">idx_ineqs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">b</span><span class="p">[</span><span class="n">idx_ineqs_ok</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_</span><span class="p">[</span><span class="n">idx_ineqs_ok</span><span class="p">]</span>
    
    <span class="c1">#least squares</span>
    <span class="n">sol</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">lsqr</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="c1">#de var a subesp</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">q0</span> <span class="o">-</span> <span class="n">sol</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">diags</span><span class="p">(</span><span class="n">q0</span><span class="p">)</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>

    <span class="n">thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">th_min</span><span class="p">,</span> <span class="n">th_max</span><span class="p">,</span> <span class="n">max_iters</span><span class="p">)</span><span class="o">**</span><span class="n">pt</span>
    <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_coef</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">max_coef</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">max_iters</span><span class="p">)</span><span class="o">**</span><span class="n">pc</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">check_sol</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">max_tries</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Thresh </span><span class="si">{thresh[-i]:.2f}</span><span class="s2"> Coef </span><span class="si">{coefs[-i]:.2f}</span><span class="s2"> { {k:round(v, 2) for k,v in res.items()} } "</span><span class="p">)</span>
        <span class="n">ort</span> <span class="o">=</span> <span class="n">orth</span><span class="p">((</span><span class="n">A</span> <span class="o">@</span> <span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">todense</span><span class="p">())</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">W</span> <span class="o">@</span> <span class="n">ort</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">o</span> <span class="o">-</span> <span class="n">base</span> <span class="o">@</span> <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">o</span><span class="p">))</span>
        <span class="n">q_</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">sol</span>
        <span class="n">res_</span> <span class="o">=</span> <span class="n">check_sol</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">q_</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">th1</span><span class="o">=</span><span class="n">th_max</span><span class="p">,</span> <span class="n">th2</span><span class="o">=</span><span class="n">th_min</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">res_</span><span class="p">[</span><span class="s1">'Max'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">res</span><span class="p">[</span><span class="s1">'Max'</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">res_</span><span class="p">[</span><span class="s1">'Min'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">res</span><span class="p">[</span><span class="s1">'Min'</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">res_</span><span class="p">[</span><span class="s1">'Norm Aq-b'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">res</span><span class="p">[</span><span class="s1">'Norm Aq-b'</span><span class="p">]</span> <span class="o">-</span> <span class="n">margin</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">shuffle</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">thresh</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="n">max_tries</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">'Max tries reached.'</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q_</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res_</span>    
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="p">(</span><span class="n">q_</span> <span class="o">-</span> <span class="n">q0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">W</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">coefs</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">])</span> 
    <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">res</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Example">Example<a class="anchor-link" href="../Entre%20gradientes/#Example">Â¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Ejemplo: tenemos 5 clientes con 2 productos cada uno</span>
<span class="c1"># Las restricciones serÃ¡n: el cliente 1 no puede tener mas del 30% del total </span>
<span class="c1"># el presupuestp del producto 1 es 100</span>
<span class="c1"># el presupuesto del producto 2 es 200</span>

<span class="c1"># Tenemos entonces un vector binario de largo q = clientes * productos</span>
<span class="c1"># Cada fila representa: (cl1) p1 p2 (cl2) p1 p2 (cl3) p11 pl2 (cl4) p1 p2 (cl5) p1 p2</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Restricciones</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">([</span>
              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'int8'</span><span class="p">)</span>
<span class="c1">#objetivos</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="o">*</span><span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
<span class="c1">#var</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e-10</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
<span class="c1"># Ahora definimos una distribucion prior: </span>
<span class="c1"># En el Ãºltimo mes, lo vendido fue</span>
<span class="n">q0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">idx_ineqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">q_ras</span> <span class="o">=</span> <span class="n">solve_nras</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">q0</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">idx_ineqs</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [31]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">check_sol</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">q_ras</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[31]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>({'Norma q-q0': 1.3931774622745055,
  'Norma Aq-b': 16.11046206365025,
  'Max': -0.024773658153136036,
  'Min': -0.6713817340258267},
 False)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [28]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">q_ultra</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">solve_ultra</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">idx_ineqs</span><span class="p">)</span>
<span class="n">check_sol</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">q_ultra</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Thresh 1.00 Coef 5.00 {'Norma q-q0': 0.0, 'Norma Aq-b': 163.31, 'Max': 0.0, 'Min': 0.0} 
Thresh 0.92 Coef 4.60 {'Norma q-q0': 1.33, 'Norma Aq-b': 0.0, 'Max': 0.14, 'Min': -0.86} 
Thresh 0.84 Coef 4.22 {'Norma q-q0': 1.33, 'Norma Aq-b': 0.0, 'Max': 0.14, 'Min': -0.86} 
</pre>
</div>
</div>

<div class="output_area">

    <div class="prompt output_prompt">Out[28]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>({'Norma q-q0': 1.3328353329549263,
  'Norma Aq-b': 1.4210854715202004e-13,
  'Max': 0.14136896611530037,
  'Min': -0.8568938273048282},
 False)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [29]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">R</span> <span class="o">@</span> <span class="n">q0</span><span class="p">,</span> <span class="n">R</span> <span class="o">@</span> <span class="n">q_ras</span><span class="p">,</span> <span class="n">R</span> <span class="o">@</span> <span class="n">q_ultra</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[29]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>(array([ 60., 263., 210.]),
 array([ 43.89156156, 100.25534034, 200.00057915]),
 array([ 60., 100., 200.]))</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [30]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">R</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[30]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>matrix([[1, 1, 0, 0, 0, 0, 0, 0, 0, 0],
        [1, 0, 1, 0, 1, 0, 1, 0, 1, 0],
        [0, 1, 0, 1, 0, 1, 0, 1, 0, 1]], dtype=int8)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [22]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">todense</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[22]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>[matrix([[ 0. , -1. ,  1. ,  0. ,  1. ,  0. ,  1. ,  0. ,  1. ,  0. ],
         [-0.5,  0. ,  0. ,  0.5,  0. ,  0.5,  0. ,  0.5,  0. ,  0.5],
         [-1. ,  1. , -1. ,  1. , -1. ,  1. , -1. ,  1. , -1. ,  1. ]]),
 matrix([[ 0. , -0.5, -0.5,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ],
         [-1. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. , -1. ],
         [ 1. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  1. ]])]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">sparse</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span> <span class="k">as</span> <span class="nn">linalg</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [32]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [33]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sol</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [34]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">o</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-</span> <span class="n">sol</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [35]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">R_null</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">null_space</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [36]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">p</span> <span class="o">=</span>  <span class="n">R_null</span> <span class="o">@</span> <span class="p">(</span><span class="n">R_null</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">o</span><span class="p">)</span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [37]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">([</span>
              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'int8'</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="o">*</span><span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>

<span class="c1"># Ahora definimos una distribucion prior: </span>
<span class="c1"># En el Ãºltimo mes, lo vendido fue</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">40</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [38]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sol</span> <span class="o">+</span> <span class="n">p</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[38]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>array([0., 0., 0.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [39]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[39]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>array([[ 0.,  1.,  0.],
       [ 0., -1.,  1.],
       [ 1., -1., -0.]])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [70]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#A @ q</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [71]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Ejemplo: tenemos 5 clientes con 2 productos cada uno</span>
<span class="c1"># Las restricciones serÃ¡n: el cliente 1 no puede tener mas del 30% del total </span>
<span class="c1"># el presupuestp del producto 1 es 100</span>
<span class="c1"># el presupuesto del producto 2 es 200</span>

<span class="c1"># Tenemos entonces un vector binario de largo q = clientes * productos</span>
<span class="c1"># Cada fila representa: (cl1) p1 p2 (cl2) p1 p2 (cl3) p11 pl2 (cl4) p1 p2 (cl5) p1 p2</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [72]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">q_</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [74]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># resultado anterior, diferencia</span>
<span class="n">A</span> <span class="o">@</span> <span class="n">q_</span><span class="p">,</span> <span class="n">A</span> <span class="o">@</span> <span class="n">q_</span> <span class="o">-</span> <span class="n">b</span><span class="p">,</span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[74]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>(array([110., 116., 147.]), array([ 20.,  16., -53.]))</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">sparse</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span> <span class="k">as</span> <span class="nn">linalg</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [32]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [33]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sol</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [34]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">o</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-</span> <span class="n">sol</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [35]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">R_null</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">null_space</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [36]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">p</span> <span class="o">=</span>  <span class="n">R_null</span> <span class="o">@</span> <span class="p">(</span><span class="n">R_null</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">o</span><span class="p">)</span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [37]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">([</span>
              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'int8'</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="o">*</span><span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>

<span class="c1"># Ahora definimos una distribucion prior: </span>
<span class="c1"># En el Ãºltimo mes, lo vendido fue</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">40</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [38]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sol</span> <span class="o">+</span> <span class="n">p</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[38]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>array([0., 0., 0.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [39]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[39]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>array([[ 0.,  1.,  0.],
       [ 0., -1.,  1.],
       [ 1., -1., -0.]])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [70]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#A @ q</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [71]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Ejemplo: tenemos 5 clientes con 2 productos cada uno</span>
<span class="c1"># Las restricciones serÃ¡n: el cliente 1 no puede tener mas del 30% del total </span>
<span class="c1"># el presupuestp del producto 1 es 100</span>
<span class="c1"># el presupuesto del producto 2 es 200</span>

<span class="c1"># Tenemos entonces un vector binario de largo q = clientes * productos</span>
<span class="c1"># Cada fila representa: (cl1) p1 p2 (cl2) p1 p2 (cl3) p11 pl2 (cl4) p1 p2 (cl5) p1 p2</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [72]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">q_</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [74]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># resultado anterior, diferencia</span>
<span class="n">A</span> <span class="o">@</span> <span class="n">q_</span><span class="p">,</span> <span class="n">A</span> <span class="o">@</span> <span class="n">q_</span> <span class="o">-</span> <span class="n">b</span><span class="p">,</span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[74]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>(array([110., 116., 147.]), array([ 20.,  16., -53.]))</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [75]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">q_</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[75]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>array([50., 60., 10., 20., 40., 20.,  4.,  7., 12., 40.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Results">Results<a class="anchor-link" href="../Entre%20gradientes/#Results">Â¶</a>
</h5>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="../Entre%20gradientes/resultsNRAS.png" alt=""><img src="../Entre%20gradientes/resultsPROJ.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Conectamos a la base y traemos los datos</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">precision</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">max_tries</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">periodo</span> <span class="o">=</span> <span class="s1">'201909'</span>
</pre></div>

    </div>
</div>
</div>

</div>conn = pyodbc.connect('Driver={SQL Server Native Client 11.0};'
                    'Server=;'
                    'Database=;'
                    'Trusted_Connection=no;'
                    'UID=;'
                    'PWD=;'
                    'PORT=1433;'
                    )# Es posible que el fillna y reset index no sean necesarios
restr = pd.read_sql('SELECT * from RestriccionesView WHERE Periodo = '+str(periodo), conn).fillna(np.nan)
PRESUP = pd.read_sql('SELECT * from PresupuestosView WHERE Periodo = '+str(periodo), conn).fillna(np.nan)
restr = restr.append(PRESUP).reset_index()
PRESUP = PRESUP.set_index('Prod')['Cantidad']%%time
query = f""""""
Q = pd.read_sql(query, conn)i = 0
for name, df in [('Q', Q),
           ('restr', restr),
           ('PRESUP', PRESUP)]:
    df.to_csv(name+'.csv')
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Q</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'Q.csv'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">restr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'restr.csv'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">PRESUP</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">'PRESUP.csv'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">PRESUP</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Prod'</span><span class="p">,</span> <span class="s1">'Cant'</span><span class="p">]</span>
<span class="n">PRESUP</span> <span class="o">=</span> <span class="n">PRESUP</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Prod'</span><span class="p">)[</span><span class="s1">'Cant'</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Observamos las tablas</span>
<span class="n">Q</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[7]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead><tr style="text-align: right;">
<th></th>
      <th>Periodo</th>
      <th>Cliente</th>
      <th>Suc</th>
      <th>Prod</th>
      <th>Flia</th>
      <th>VtaNeta</th>
      <th>WarmStart</th>
      <th>Z</th>
      <th>Canal</th>
      <th>Zona</th>
      <th>CMHSA</th>
      <th>GrupoEconomico</th>
    </tr></thead>
<tbody>
<tr>
<th>588171</th>
      <td>201909</td>
      <td>432834</td>
      <td>1</td>
      <td>1658</td>
      <td>13</td>
      <td>3.6</td>
      <td>2.953085</td>
      <td>NaN</td>
      <td>311</td>
      <td>2395</td>
      <td>0</td>
      <td>NaN</td>
    </tr>
<tr>
<th>1235915</th>
      <td>201909</td>
      <td>499634</td>
      <td>1</td>
      <td>446</td>
      <td>7</td>
      <td>7.2</td>
      <td>5.453880</td>
      <td>NaN</td>
      <td>310</td>
      <td>2381</td>
      <td>301</td>
      <td>NaN</td>
    </tr>
<tr>
<th>1090837</th>
      <td>201909</td>
      <td>90692</td>
      <td>1</td>
      <td>1662</td>
      <td>13</td>
      <td>1.0</td>
      <td>0.746506</td>
      <td>NaN</td>
      <td>311</td>
      <td>2420</td>
      <td>0</td>
      <td>NaN</td>
    </tr>
<tr>
<th>131802</th>
      <td>201909</td>
      <td>470525</td>
      <td>1</td>
      <td>3491</td>
      <td>1</td>
      <td>304.0</td>
      <td>315.951584</td>
      <td>NaN</td>
      <td>311</td>
      <td>2382</td>
      <td>0</td>
      <td>NaN</td>
    </tr>
<tr>
<th>389881</th>
      <td>201909</td>
      <td>195433</td>
      <td>2</td>
      <td>1459</td>
      <td>13</td>
      <td>1.4</td>
      <td>1.115930</td>
      <td>NaN</td>
      <td>311</td>
      <td>2388</td>
      <td>0</td>
      <td>NaN</td>
    </tr>
</tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">## GrupoEconomico NaN ?</span>
<span class="n">display</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="s1">'GrupoEconomico'</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>




<div class="output_text output_subarea ">
<pre>array([ nan, 394., 395., 414., 385., 389., 402., 410., 406., 383., 397.,
       409., 408., 391., 384., 387., 411., 388., 403., 401., 393., 407.,
       404., 396., 392., 405., 400., 413., 390., 412., 398., 386., 399.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">restr</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[9]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead><tr style="text-align: right;">
<th></th>
      <th>CMHSA</th>
      <th>Canal</th>
      <th>Cantidad</th>
      <th>Cliente</th>
      <th>Flia</th>
      <th>GrupoEconomico</th>
      <th>Periodo</th>
      <th>PorcentajeRelativo</th>
      <th>PorcentajeTotal</th>
      <th>Prod</th>
      <th>Simb</th>
      <th>Suc</th>
      <th>Zona</th>
    </tr></thead>
<tbody>
<tr>
<th>0</th>
      <td>NaN</td>
      <td>308.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>201909</td>
      <td>NaN</td>
      <td>30.0</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
<tr>
<th>1</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>71100.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>201909</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>15.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
<tr>
<th>2</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>170786.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>201909</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>44.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
<tr>
<th>3</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>160496.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>201909</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>52.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
<tr>
<th>4</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>246550.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>201909</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>54.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
<tr>
<th>5</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>1947.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>201909</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>56.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
<tr>
<th>6</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>5643.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>201909</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>58.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
<tr>
<th>7</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>48390.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>201909</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>64.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
<tr>
<th>8</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>91361.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>201909</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>67.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
<tr>
<th>9</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>8011.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>201909</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>68.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
</tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Q</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[10]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>(1612076, 12)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Preparamos las matrices A y b para resolver A @ q &lt;= b</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="s1">'WarmStart'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">pr_fl</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'Prod'</span><span class="p">)[</span><span class="s1">'Flia'</span><span class="p">]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

<span class="n">A</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">restr</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">' '</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="s1">'Zona'</span><span class="p">,</span> <span class="s1">'CMHSA'</span><span class="p">,</span> <span class="s1">'Canal'</span><span class="p">,</span> <span class="s1">'GrupoEconomico'</span><span class="p">,</span> <span class="s1">'Cliente'</span><span class="p">,</span> <span class="s1">'Suc'</span><span class="p">,</span> <span class="s1">'Flia'</span><span class="p">,</span> <span class="s1">'Prod'</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">([(</span><span class="n">Q</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cols</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="n">A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">'Cantidad'</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">'Flia'</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="s1">'Prod'</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">)):</span>
            <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'Cantidad'</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PRESUP</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">elif</span> <span class="s1">'PorcentajeRelativo'</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">uni</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'PorcentajeRelativo'</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="s1">'WarmStart'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">@</span> <span class="n">mask</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uni</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">'PorcentajeTotal'</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">'Flia'</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
            <span class="n">uni</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'PorcentajeTotal'</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">PRESUP</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pr_fl</span><span class="p">[</span><span class="n">pr_fl</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Flia'</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">elif</span> <span class="s1">'Prod'</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">uni</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'PorcentajeTotal'</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">PRESUP</span><span class="p">[</span><span class="n">pr_fl</span><span class="p">[</span><span class="n">pr_fl</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">'Prod'</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uni</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">'PorcentajeTotal'</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">PRESUP</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uni</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Error en restriccion."</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Restricciones terminadas.'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">idx_ineqs</span> <span class="o">=</span> <span class="n">restr</span><span class="p">[</span><span class="n">restr</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">'Simb'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'int32'</span><span class="p">)</span>
<span class="c1">#del restr</span>
<span class="c1">#del PRESUP</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'bool'</span><span class="p">))</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'int64'</span><span class="p">)</span>

<span class="c1"># Las 3 listas deberÃ­an dar vacÃ­as</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Idx de restricciones con 0 variables'</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Idx de objetivos = 0'</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Idx donde q = 0'</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Idx de restricciones con 0 variables [132]
Idx de objetivos = 0 [132]
Idx donde q = 0 []
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">restr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[13]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead><tr style="text-align: right;">
<th></th>
      <th>CMHSA</th>
      <th>Canal</th>
      <th>Cantidad</th>
      <th>Cliente</th>
      <th>Flia</th>
      <th>GrupoEconomico</th>
      <th>Periodo</th>
      <th>PorcentajeRelativo</th>
      <th>PorcentajeTotal</th>
      <th>Prod</th>
      <th>Simb</th>
      <th>Suc</th>
      <th>Zona</th>
    </tr></thead>
<tbody><tr>
<th>132</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>201909</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3150.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr></tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Si no es True, falla</span>
<span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[14]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[15]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>((147, 1612076), (1612076,), (147,))</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">'A.npy'</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">'b.npy'</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">'q.npy'</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Calculamos la distribuciÃ³n. EL nÃºmero que se imprime es el "error", o </span>
<span class="c1"># diferencia total entre los valores actuales y las restricciones</span>

<span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> 
          <span class="n">idx_ineqs</span> <span class="o">=</span> <span class="p">[],</span>
          <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
          <span class="n">precision</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
          <span class="n">max_tries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">d_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">q</span><span class="p">))</span>
        <span class="n">idx_ineqs_ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">idx_ineqs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
        <span class="n">p</span><span class="p">[</span><span class="n">idx_ineqs_ok</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">q</span><span class="p">))[[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idx_ineqs_ok</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"</span><span class="si">{d:.2f}</span><span class="s2">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">' '</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;=</span> <span class="n">d_</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">d_</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">max_tries</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">d_</span> <span class="o">&lt;</span> <span class="n">precision</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="n">A_</span><span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">true_divide</span><span class="p">(</span><span class="n">A_</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">A_</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))))</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">P</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'NaN error. Hay 0s en q, probable restricciÃ³n invÃ¡lida.'</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">q</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">idx_ineqs</span><span class="p">)</span>
<span class="n">Q</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">'Z'</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[[</span><span class="s1">'Periodo'</span><span class="p">,</span> <span class="s1">'Cliente'</span><span class="p">,</span> <span class="s1">'Suc'</span><span class="p">,</span> <span class="s1">'Prod'</span><span class="p">,</span> <span class="s1">'Flia'</span><span class="p">,</span> <span class="s1">'VtaNeta'</span><span class="p">,</span> <span class="s1">'WarmStart'</span><span class="p">,</span> <span class="s1">'Z'</span><span class="p">]]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>5455867.49 2823397.58 2280243.73 1913913.87 1626890.86 1390675.24 1192678.69 1025278.65 883003.76 761623.13 657756.33 568656.08 492064.84 426111.84 369235.97 320126.90 277679.21 240956.31 209161.73 181616.01 157737.93 137029.18 119061.63 103466.86 89927.35 78169.12 67955.48 59081.74 51370.83 44669.35 38844.41 33780.79 29378.57 25551.03 22222.91 19328.85 16812.12 14623.40 12719.87 11064.31 9624.37 8371.93 7282.56 6335.00 5510.77 4793.82 4170.17 3627.67 3155.76 2745.25 2388.15 2077.51 1807.28 1572.20 1367.71 1189.81 1035.06 900.43 783.32 681.43 592.80 515.70 448.63 390.28 339.52 295.36 256.95 223.53 194.46 169.17 147.16 128.02 111.37 96.89 84.29 73.32 63.79 55.49 48.27 42.00 36.53 31.78 27.65 24.05 20.92 18.20 15.84 13.78 11.98 10.43 9.07 

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Difs:{(A @ q - b)[:10]}"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

<span class="n">neto_col</span> <span class="o">=</span> <span class="s1">'VtaNeta'</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">check_sol</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Difs:[ 8.646 -0.    -0.015 -0.004 -0.025 -0.    -0.    -0.003 -0.006 -0.   ]

Norma 1552.35
Max 3.28
Min 0.53
Media 1.19
Mayores a 1.00 1443791
Mayores a 0.30 1612076
Negativos 0
Norm Aq-b 9.069
</pre>
</div>
</div>

<div class="output_area">

    <div class="prompt"></div>




<div class="output_png output_subarea ">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAX4AAAESCAYAAAD67L7dAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAADl0RVh0U29mdHdhcmUAbWF0cGxvdGxpYiB2ZXJzaW9uIDMuMC4zLCBodHRwOi8vbWF0cGxvdGxpYi5vcmcvnQurowAAE3FJREFUeJzt3X+M5HV9x/Hn7u1553rbKtv1lN9WjncJIhS8tia1SY2iktKixiBRMalaRCN/GGqjJkhsMFRIG1ETVFoFTGhCasEaQipJaUAlHhGoIH0DooAc4LpH6t2tDPurf8zcOezO7Hxnd/bHzOf5SAgzn+9nZt+f++6+9ruf+cxnhhYWFpAklWN4owuQJK0vg1+SCmPwS1JhDH5JKozBL0mFMfglqTAGvyQVxuCXpMIY/JJUGINfkgpj8EtSYUY2uoCGbcBu4ClgboNrkaR+sQV4JbAHqFV90GYJ/t3AHRtdhCT1qTcAd1btvFmC/ymAZ589yPx8691Cx8d3MDV1YF2LWm+DPsZBHx84xkHQT+MbHh7iZS97CTQytKrNEvxzAPPzC22D/9DxQTfoYxz08YFjHAR9OL6upsh9cVeSCmPwS1JhDH5JKozBL0mFMfglqTAGvyQVxuCXpMJslnX8WiOz81CbmW15bNvWEUb81S8Vx+AfcLWZWfY8+EzLY7tP2snINr8FpNJ4vSdJhTH4JakwBr8kFcbgl6TCGPySVBiDX5IKY/BLUmEMfkkqjMEvSYUx+CWpMAa/JBXG4Jekwhj8klSYjlszRsQ4cD3waqAGPAJckJmTi/p9A3gT8KtG042ZeVlPq5UkrVqVPXkXgM9n5u0AEXEFcDnwgRZ9L8/ML/WuPElSr3UM/szcB9ze1HQXcOFaFaSN1+7DW/zgFmkwdPUpHBExTD30v92my8cj4gLgp8AnM/PBVdanDdDuw1v84BZpMHT7U/xF4ADQajrn08BTmTkfEecDt0bE72fmXNUnHx/fsezxiYmxbmrtS70e48K+acZ2bG95bHR0GxNHjFZ+TLv+3fAcDoZBH+Ogj69y8EfElcAu4OzMnF98PDOfbLp9XUT8E3A08FjVrzE1dYD5+YWWxyYmxpic3F/1qfrSWoxxujbL/gPPtT42XWNybunv5XaPade/Ks/hYBj0MfbT+IaHhzpeMLd8XJVOEXEZcAZwTmbW2vQ5qun2W4A54MlWfSVJG6fKcs6TgU8BDwHfjwiAn2Xm2yPiXuCszNwLXBsRO4F54NfAX2bm0lcIJUkbqsqqngeAoTbHTmu6/aYe1iVJWiMuzpOkwhj8klQYg1+SCmPwS1JhDH5JKozBL0mFMfglqTAGvyQVxuCXpMK4x26fca98Satl8PcZ98qXtFpeI0pSYQx+SSqMwS9JhTH4JakwBr8kFcbgl6TCGPySVBiDX5IKY/BLUmEMfkkqjMEvSYUx+CWpMAa/JBXG4Jekwhj8klQYg1+SCmPwS1JhDH5JKkzHz+qLiHHgeuDVQA14BLggMycX9RsFvg6cAcwCF2fmd3pesSRpVapc8S8An8/MyMzXAj8FLm/R72Jgf2aeAJwNXBMRO3pXqiSpFzoGf2buy8zbm5ruAo5r0fVc4OrGYx4G7gbe1oMaJUk91NUcf0QMAxcC325x+Fjgsab7jwPHrLw0SdJa6DjHv8gXgQPAl9agFsbHl58ZmpgYW4svu6l0GuPCvmnGdmxf0j46uo2JI0Yr91/JY9r174bncDAM+hgHfXyVgz8irgR2AWdn5nyLLo9TnwI69KLvscB/dVPM1NQB5ucXWh6bmBhjcnJ/N0/Xd6qMcbo2y/4Dzy1tn64xOTdXuf9KHtOuf1Wew8Ew6GPsp/ENDw91vGBu+bgqnSLiMuqrdc7JzFqbbjcCFzT67wJ2A7d2XZEkaU11DP6IOBn4FHAk8P2IuDci/r1x7N6IOLLR9QrgpRHxCPAd4G8ysz9+bUpSQTpO9WTmA8BQm2OnNd0+CLyrd6VJktaC79yVpMJ0u6pHA2RoeIiDtdkl7W1eX5c0IAz+gtVm5rjvockl7aeeOLEB1UhaL071SFJhDH5JKozBL0mFMfglqTAGvyQVxuCXpMIY/JJUGINfkgpj8EtSYQx+SSqMwS9JhXGvngHhhmuSqjL4B4QbrkmqyqkeSSqMwS9JhTH4JakwBr8kFcbgl6TCGPySVBiDX5IKY/BLUmEMfkkqjMEvSYUx+CWpMAa/JBXG4JekwlTanTMirgTeCRwPnJKZ97focynwEWBvo+l7mfnR3pQpSeqVqtsy3wR8AbijQ7/rMvPi1ZUkSVpLlYI/M+8EiIi1rUaStOZ6/UEs746IM4Gngc9k5g+6efD4+I5lj09MjK2itP7QaYwL+6YZ27F9SfvWrSNdta/kMaOj25g4YnTZ+jrxHA6GQR/joI+vl8F/NXBZZs5ExJuBmyPipMycqvoEU1MHmG/zWYETE2NMTu7vUambU5UxTtdm2X/guSXtMzPdta/kMdPTNSbn5patbzmew8Ew6GPsp/ENDw91vGBu+bheFZCZT2fmTOP2d4EngNf06vklSb3Rs+CPiKOabp9GfQVQ9ur5JUm9UXU551XAO4BXALdFxFRmnhwRtwCXZObdwOci4gxgDngeeF9mPr1WhUuSVqbqqp6LgItatJ/VdPv9PaxLkrRGfOeuJBXG4JekwvR6Hb+6MDsPtZnZw/cX9k0zXavf37Z1hBF/LUtaAwb/BqrNzLLnwWcO3x/bsf3w+vndJ+1kZJunR1LveU0pSYUx+CWpMAa/JBXG4Jekwhj8klQYg1+SCmPwS1JhDH5JKozBL0mFMfglqTAGvyQVxuCXpMIY/JJUGINfkgpj8EtSYQx+SSqMwS9JhTH4JakwBr8kFcbgl6TCGPySVBiDX5IKY/BLUmEMfkkqzEinDhFxJfBO4HjglMy8v0WfLcBVwFuBBeDyzLymt6VKknqhyhX/TcCfAY8t0+c9wAnALuD1wKURcfyqq5Mk9VzH4M/MOzPziQ7dzgW+lpnzmTlJ/ZfFu3pRoCSpt3o1x38sL/yL4HHgmB49tySphzrO8a+n8fEdyx6fmBhbp0rWx8K+acZ2bH9B26H7o6PbmDhitNJjALZuHemqfSWPaVdTNwbtHLbiGPvfoI+vV8H/OHAcsKdxf/FfAJVMTR1gfn6h5bGJiTEmJ/evuMDNaLo2y/4Dzx2+P7Zj++H709M1JufmOj7mkJmZ7tpX8ph2NVU1iOdwMcfY//ppfMPDQx0vmFvpVfDfCHwoIr4FjAPnUH9BWJK0yXSc44+IqyLiF8DRwG0R8UCj/ZaIeF2j2/XAo8DDwF3AZzPz0TWqWZK0Ch2v+DPzIuCiFu1nNd2eAy7sbWmSpLXgO3clqTAGvyQVxuCXpMIY/JJUGINfkgpj8EtSYQx+SSqMwS9JhdlUm7RpcxsaHuJgbXZJ+7atI4x4CSH1jYEL/tl5qM0YTmuhNjPHfQ9NLmnffdJORrYN3LeSNLAG7qe1NjPLngefWdJuOElSndfAklQYg1+SCmPwS1JhDH5JKozBL0mFMfglqTCub9yk2r1Zqs1n0UtSZQb/JtXuzVKnnjixAdVIGiRO9UhSYQx+SSqMUz1atXavR4B7JEmbkcGvVWv3egS4R5K0GXktJkmFMfglqTAGvyQVxuCXpMIY/JJUGINfkgpTaZ1dRJwIXAuMA1PA+Zn58KI+lwIfAfY2mr6XmR/tXamSpF6ousD6auDLmfnNiHgv8BXgjS36XZeZF/esOklSz3Wc6omIlwOnAzc0mm4ATo8IdwuTpD5UZY7/GODJzJwDaPx/b6N9sXdHxP9ExH9GxOt7WKckqUd6+V76q4HLMnMmIt4M3BwRJ2XmVNUnGB/fsezxiYmxjs+xsG+asR3bl7SPjm5j4ojRqqWsi1a1Hrq/detIy3H0qn29vsbif/cq57CV/dPP85vnWu8H9OLtI4yNvmhFz7sWVjrGfjLoYxz08VUJ/ieAoyJiS2bORcQW4MhG+2GZ+XTT7e9GxBPAa4D/rlrM1NQB5tt80sjExBiTk/s7Psd0bZb9B55b2j5dY3Jurmop62JxrWM7th++PzPTehy9al+vr9H87171HLZysDbLngefaXls90k7ee5gbUXP22urGWO/GPQx9tP4hoeHOl4wt3xcpw6Z+UvgXuC8RtN5wD2Z+YJduSLiqKbbpwHHA9l1RZKkNVV1qufDwLURcQnwLHA+QETcAlySmXcDn4uIM4A54Hngfc1/BUiSNodKwZ+Z/wv8cYv2s5puv7+HdUmS1ojv3JWkwhj8klQYg1+SCtOXn4k3Ow+1mdZrutusBpUkNfRl8Ndm2q/pPvVEd5KQpOU41SNJhenLK371j6HhIQ7W6tNyC/ummW7c3rZ1hBEvO6QNYfBrTdVm5rjvofqbvJu3pNh90k5GtvntJ20Er7kkqTAGvyQVxuCXpMI4yaoN0fyibzNf9JXWnsGvDdH8om8zX/SV1p7XVpJUGINfkgpTzN/UzilLUl0xwe+csiTVea0rSYUx+CWpMAa/JBXGyW1tKu1ehPcDdqTeKT74Xe2zubR7EX4lH7DT7pPaPLcqXfHB72qfwdXuk9o8tyqd3/3qe04PSd0x+NX3ejk9JJXAmU5JKozBL0mFMfglqTDO8as4LuFV6SoFf0ScCFwLjANTwPmZ+fCiPluAq4C3AgvA5Zl5TW/LXT/twgG6D4h268lddbIxXMKr0lX9Lr8a+HJmfjMi3gt8BXjjoj7vAU4AdlH/BXFPRNyWmT/vVbHrqV04QPcB0W49uatO+kO7X9zgXwnqTx3TKyJeDpwOvLnRdAPwpYiYyMzmZDwX+FpmzgOTEXET8C7gigp1bAEYHh5attOh4yNbhhndvrVln3bHetV+6FinWlfyNV68bYS52a3rOo71/BprMb5ej6PVeZ2bneOBn+1r+bVPPeH3eNHIlhe0DQ8PMTcPz8/OLen/opEtbBmAXxTdfP93shn/rXo5vrXUVOeW5fotNrSwsPx8Q0ScAVyXmSc3tf0EeG9m/qip7cfAX2fmnsb9TwBHZ+ZFFer4U+CObgqXJB32BuDOqp03y4TmHuqFPwUs/dUvSWplC/BK6hlaWZXgfwI4KiK2ZOZc40XcIxvtzR4Hjmsq4FjgsYp11Ojit5Uk6bCfdvuAjjNomflL4F7gvEbTecA9i+b3AW4EPhQRwxExAZwD/Fu3BUmS1lbVl04+DHwsIh4CPta4T0TcEhGva/S5HngUeBi4C/hsZj7a43olSavU8cVdSdJgGYCFZZKkbhj8klQYg1+SCmPwS1JhNssbuIDKm8FdCnwE2Nto+l5mfnQ961ypiLgSeCdwPHBKZt7fok9fb3ZXcYyX0r/ncJz6CrZXU3//ySPABYuXN0fEKPB14AxgFrg4M7+zzuWuSBdj/AbwJuBXjaYbM/OydSx1xRpbyrwKmAcOAB/LzHsX9enrn8XlbKrgp9pmcFDfQuLi9S2tJ24CvsDy21P0+2Z3VcYI/XsOF4DPZ+btABFxBXA58IFF/S4G9mfmCRGxC7gjIk7IzAPrWu3KVB0j1MPwS+tYW6+8PzP/DyAi/gr4F+p7kjXr95/FtjbNVE/TZnA3NJpuAE5vvBlsIGTmnZm5+B3Pix3e7K5xhXVos7u+UHGMfSsz9x0KxIa7qL9jfbFzqV/I0Pir9W7gbWteYA90Mca+dSj0G36X+pX/Yn39s7iczXTFfwzwZGbOATS2h9jbaF/8LuF3R8SZwNPAZzLzB+tb6ppavNXF49T/DQZN35/DiBgGLgS+3eLwQJzHDmME+HhEXEB924BPZuaD61bcKkXENcCZwBD16ZzFBuIctrJprvi7cDXwqsx8LfUtn29uzEmqfwzKOfwi9fnhfpzqqGq5MX4aOCEzTwG+BdzamBfvC5n5wcw8FvgU1baPHxibKfgPbwYHh19YWbIZXGY+nZkzjdvfbRx/zTrXupYObXZ3yLEs3RCvrw3COWy8iL0LOLfxGRSL9f157DTGzHzyUHtmXgfsAI5e3ypXLzOvB/68xcVH35/DdjZN8FfdDC4ijmq6fRr11SO5TmWuh4Hf7K7fz2FEXEZ9tc45mVlr0+1G4IJG/13AbuDW9alw9aqMcdF5fAv1LdWfXJ8KVy4idkTEMU33zwb2Nf5rNrA/i5tqr56I+APqyzlfBjxLfTlnRsQtwCWZeXdEXEv9G3IOeJ76/PAtG1Z0FyLiKuAdwCuoL4GbysyTF41vC/U/q89sPOwfMvOrG1Nx9yqOsZ/P4cnA/cBDwG8azT/LzLdHxL3AWZm5NyJeAnwD+EPq4/xEZt68ETV3q4sx3gbspP7C6K+Bv83Muzak6C5ExE7gZuAl1M/NPurLbX80SD+Ly9lUwS9JWnubZqpHkrQ+DH5JKozBL0mFMfglqTAGvyQVZjNt2SBtWhFxNfUtRf6+cf9C4FLqSwKPy8ypDSxP6orLOSUgIn5OfU36LPW13T8BrgO+uvhdqxGxlfq69T/JzPvWt1Jp9ZzqkX7r7Mwco/42/cuBvwP+uUW/ncB24IF1rE3qGa/4JQ5f8X8wM29ravsj6lsSv5b6/vq/oP5XwD3AKHAQ+GFmtvrMCGnT8opfaiMzf0g97N/Q1PYQcHLj7ksNffUjg19a3l7giI0uQuolg19a3lEs3bVR6msGv9RGROymHvx3bnQtUi8Z/NIiEfE7EfEXwL8C38zMH290TVIv+QYu6bf+IyJmqe8v/xPgH2l8YLo0SFzOKUmFcapHkgpj8EtSYQx+SSqMwS9JhTH4JakwBr8kFcbgl6TCGPySVBiDX5IK8/8td/aPwVZiIAAAAABJRU5ErkJggg==">
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Vemos los cambios proporcionales entre el nuevo presupuesto y el anterior</span>

<span class="n">dif</span> <span class="o">=</span> <span class="n">PRESUP</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'Prod'</span><span class="p">)[</span><span class="s1">'VtaNeta'</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">dif</span><span class="o">.</span><span class="n">sort_values</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">f</span><span class="s2">"Max: {dif.max():.3f}| Min: {dif.min():.3f} | Mean: {dif.mean():.3f}"</span><span class="p">)</span>
<span class="n">Q</span><span class="p">[</span><span class="s1">'DifProd'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dif</span><span class="p">[</span><span class="n">Q</span><span class="p">[</span><span class="s1">'Prod'</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>




<div class="output_text output_subarea ">
<pre>Prod
69          0.277926
68          0.326646
254         0.398631
1120        0.401962
3090        0.450653
288         0.474737
1172        0.488993
1171        0.548577
54          0.565005
944         0.572995
438         0.580744
1771        0.593207
1670        0.613379
1661        0.616917
769         0.627993
1629        0.636292
653         0.655964
1870        0.658470
1711        0.660857
711         0.668543
714         0.672762
487         0.676697
660         0.679085
3450        0.680600
3085        0.680800
1655        0.684944
325         0.685562
1710        0.686097
1418        0.689068
1042        0.689124
            ...     
289         0.978796
941         0.988392
635         0.989566
1412        0.997511
3491        1.039314
190         1.047416
376         1.050622
940         1.051760
15          1.057603
1862        1.076837
3710        1.100140
56          1.104681
560         1.163106
724         1.173556
3321        1.201903
1947        1.241589
959         1.269711
960         1.299728
779         1.347084
1945        1.355963
778         1.424546
1860        1.445922
942         1.892076
943         2.065215
1309        2.519752
3063        2.557514
1308        3.807042
72       3852.941176
151     13555.625000
3150             NaN
Length: 146, dtype: float64</pre>
</div>

</div>

<div class="output_area">

    <div class="prompt"></div>




<div class="output_text output_subarea ">
<pre>'Max: 13555.625| Min: 0.278 | Mean: 120.921'</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [20]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">res_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">Q</span><span class="p">[</span><span class="s1">'VtaNeta'</span><span class="p">]))</span>
<span class="n">res_warm</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">Q</span><span class="p">[</span><span class="s1">'WarmStart'</span><span class="p">]))</span>
<span class="n">res_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">Q</span><span class="p">[</span><span class="s1">'Z'</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [21]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Valores proporcionales previos con respecto a los objetivos</span>
<span class="n">res_0</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[21]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>array([    0.692,     1.058,     0.75 ,     0.699,     0.565,     1.105,
           0.86 ,     0.824,     0.708,     0.327,     0.278,  3852.941,
           0.79 ,     0.7  ,     0.838,     0.804, 13555.625,     0.773,
           1.047,     0.752,     0.778,     0.399,     0.741,     0.475,
           0.979,     0.686,     0.779,     0.768,     0.82 ,     1.051,
           0.8  ,     0.924,     0.581,     0.741,     0.757,     0.962,
           0.848,     0.794,     0.677,     1.163,     0.704,     0.875,
           0.892,     0.99 ,     0.808,     0.931,     0.656,     0.679,
           0.825,     0.852,     0.757,     0.832,     0.794,     0.861,
           0.805,     0.669,     0.673,     0.903,     1.174,     0.742,
           0.826,     0.755,     0.771,     0.764,     0.628,     1.425,
           1.347,     0.735,     0.708,     1.052,     0.988,     1.892,
           2.065,     0.573,     1.27 ,     1.3  ,     0.767,     0.825,
           0.689,     0.93 ,     0.402,     0.803,     0.807,     0.694,
           0.97 ,     0.549,     0.489,     3.807,     2.52 ,     0.798,
           0.792,     0.876,     0.998,     0.955,     0.913,     0.689,
           0.797,     0.695,     0.755,     0.636,     0.915,     0.834,
           0.834,     0.685,     0.82 ,     0.935,     0.617,     0.747,
           0.707,     0.859,     0.613,     0.813,     0.686,     0.661,
           0.722,     0.767,     0.734,     0.705,     0.593,     0.796,
           1.446,     0.859,     1.077,     0.658,     1.356,     0.795,
           1.242,     0.812,     2.558,     0.681,     0.716,     0.451,
             nan,     0.731,     0.804,     0.814,     0.787,     0.866,
           1.202,     0.763,     0.827,     0.681,     1.039,     0.957,
           0.713,     0.694,     1.1  ])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [22]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Valores del WarmStart con respecto a los objetivos</span>
<span class="n">res_warm</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[22]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>array([0.757, 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,   nan, 1.   , 1.   ,
       1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   , 1.   ,
       1.   , 1.   , 1.   ])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [23]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Valores resultantes </span>
<span class="n">res_1</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[23]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>array([ 1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,
        1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,
        1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,
        1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,
        1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,
        1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,
        1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,
        1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,
        1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,
        1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,
        1.,  1., nan,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,  1.,
        1.,  1.,  1.,  1.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [24]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">Q</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[24]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead><tr style="text-align: right;">
<th></th>
      <th>Periodo</th>
      <th>Cliente</th>
      <th>Suc</th>
      <th>Prod</th>
      <th>Flia</th>
      <th>VtaNeta</th>
      <th>WarmStart</th>
      <th>Z</th>
      <th>Dif</th>
      <th>DifProd</th>
    </tr></thead>
<tbody>
<tr>
<th>1307518</th>
      <td>201909</td>
      <td>496990</td>
      <td>1</td>
      <td>560</td>
      <td>1</td>
      <td>1.70</td>
      <td>1.977280</td>
      <td>2.353375</td>
      <td>1.190208</td>
      <td>1.163106</td>
    </tr>
<tr>
<th>1132321</th>
      <td>201909</td>
      <td>484980</td>
      <td>1</td>
      <td>677</td>
      <td>13</td>
      <td>0.20</td>
      <td>0.166494</td>
      <td>0.207281</td>
      <td>1.244977</td>
      <td>0.832468</td>
    </tr>
<tr>
<th>1075051</th>
      <td>201909</td>
      <td>132953</td>
      <td>78</td>
      <td>476</td>
      <td>13</td>
      <td>52.35</td>
      <td>41.549486</td>
      <td>29.590758</td>
      <td>0.712181</td>
      <td>0.793686</td>
    </tr>
<tr>
<th>1181607</th>
      <td>201909</td>
      <td>445412</td>
      <td>1</td>
      <td>1411</td>
      <td>3</td>
      <td>0.33</td>
      <td>0.288916</td>
      <td>0.347830</td>
      <td>1.203915</td>
      <td>0.875502</td>
    </tr>
<tr>
<th>929777</th>
      <td>201909</td>
      <td>428533</td>
      <td>1</td>
      <td>3346</td>
      <td>1</td>
      <td>9.00</td>
      <td>7.441349</td>
      <td>12.452869</td>
      <td>1.673469</td>
      <td>0.826817</td>
    </tr>
<tr>
<th>1289792</th>
      <td>201909</td>
      <td>407798</td>
      <td>1</td>
      <td>1661</td>
      <td>13</td>
      <td>0.20</td>
      <td>0.123383</td>
      <td>0.152416</td>
      <td>1.235307</td>
      <td>0.616917</td>
    </tr>
<tr>
<th>410550</th>
      <td>201909</td>
      <td>450135</td>
      <td>1</td>
      <td>448</td>
      <td>1</td>
      <td>1.00</td>
      <td>0.961530</td>
      <td>1.040882</td>
      <td>1.082527</td>
      <td>0.961530</td>
    </tr>
<tr>
<th>1277855</th>
      <td>201909</td>
      <td>472718</td>
      <td>1</td>
      <td>706</td>
      <td>13</td>
      <td>4.00</td>
      <td>3.220808</td>
      <td>3.270251</td>
      <td>1.015351</td>
      <td>0.805202</td>
    </tr>
<tr>
<th>1078834</th>
      <td>201909</td>
      <td>242801</td>
      <td>1</td>
      <td>406</td>
      <td>7</td>
      <td>3.60</td>
      <td>2.880523</td>
      <td>3.808080</td>
      <td>1.322010</td>
      <td>0.800145</td>
    </tr>
<tr>
<th>422656</th>
      <td>201909</td>
      <td>482999</td>
      <td>1</td>
      <td>1670</td>
      <td>13</td>
      <td>1.90</td>
      <td>1.165419</td>
      <td>1.518980</td>
      <td>1.303377</td>
      <td>0.613379</td>
    </tr>
</tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [25]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">PRESUP</span><span class="p">[</span><span class="mi">151</span><span class="p">]</span> <span class="o">/</span> <span class="n">Q</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'Prod'</span><span class="p">)[</span><span class="s1">'VtaNeta'</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()[</span><span class="mi">151</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[25]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>13555.625</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>El algoritmo falla cuando existen valores iguales a 0 en el vector <strong>q</strong> en el momento en el que se calcula <strong>b / Aq</strong>, siendo <strong>b</strong> los objetivos de las restricciones, <strong>A</strong> una matriz binaria que selecciona las variables correspondientes, y <strong>q</strong> el vector con las ventas de cada producto para cada sucursal</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="n">sol_</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">x</span> <span class="o">-</span> <span class="n">b</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">q</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)])</span>
<span class="n">sol_sci</span> <span class="o">=</span> <span class="n">sol_</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Notas:">Notas:<a class="anchor-link" href="../Entre%20gradientes/#Notas:">Â¶</a>
</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">f</span><span class="s2">"mysql+pyodbc://</span><span class="si">{UID}</span><span class="s2">:</span><span class="si">{PWD}</span><span class="s2">@</span><span class="si">{SERVER}</span><span class="s2">/</span><span class="si">{DATABASE}</span><span class="s2">?driver=SQL+Server"</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">'replace'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>
<span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">3</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">c</span>
<span class="n">PRES</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">p</span><span class="p">)</span>
<span class="n">HIST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">PRES</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">//</span><span class="n">t</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">t</span><span class="p">))</span>

<span class="c1"># Tensor con una var para cada producto+deposito+canal</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>


<span class="n">solvers</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">'CVXOPT'</span><span class="p">,</span> <span class="s1">'GLPK'</span><span class="p">,</span> <span class="s1">'GLPK_MI'</span><span class="p">,</span> <span class="s1">'SCS'</span><span class="p">,</span> <span class="s1">'LS'</span><span class="p">]</span>

<span class="n">objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum_squares</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">HIST</span><span class="p">),</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum_squares</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">HIST</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum_squares</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">HIST</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
        <span class="n">cp</span><span class="o">.</span><span class="n">sum_squares</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">HIST</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum_squares</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">HIST</span><span class="p">)</span> <span class="o">-</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum_squares</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>

<span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">solvers</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[(</span><span class="n">m</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="p">[</span><span class="s1">'=='</span><span class="p">,</span> <span class="s1">'&lt;='</span><span class="p">][</span><span class="n">z</span><span class="p">])]</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">PRES</span><span class="p">,</span> <span class="n">HIST</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">objs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">z</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[(</span><span class="n">m</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="p">[</span><span class="s1">'=='</span><span class="p">,</span> <span class="s1">'&lt;='</span><span class="p">][</span><span class="n">z</span><span class="p">])]</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">vh</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svds</span><span class="p">((</span><span class="n">A</span> <span class="o">@</span> <span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">M2</span><span class="p">,</span> <span class="n">N2</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
<span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
<span class="n">tol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">M2</span><span class="p">,</span><span class="n">N2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="n">eps</span>
<span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">ort</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,:</span><span class="n">num</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="References">References<a class="anchor-link" href="../Entre%20gradientes/#References">Â¶</a>
</h5>
<p>Belotti, P., Kirches, C., Leyffer, S., Linderoth, J., Luedtke, J., &amp; Mahajan, A. (2013). Mixed-integer nonlinear optimization. Acta Numerica, 22, 1-131.</p>
<p>Boyd, S., &amp; Vandenberghe, L. (2004). Convex optimization. Cambridge university press.</p>
<p>Paige, C. C., &amp; Saunders, M. A. (1982). LSQR: An algorithm for sparse linear equations and sparse least squares. ACM Transactions on Mathematical Software (TOMS), 8(1), 43-71.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">InÂ [Â ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="../Vocational%20Data%20Science/" rel="prev" title="Modern...ish Vocational Testing">Previous post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="musicalneuron",
            disqus_url="https://cerebrock.github.io/posts/Entre%20gradientes/",
        disqus_title="entre gradientes",
        disqus_identifier="cache/posts/CVX.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section><script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js" integrity="sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script><script>
                renderMathInElement(document.body,
                    {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "\\[", right: "\\]", display: true},
                            {left: "\\begin{equation*}", right: "\\end{equation*}", display: true},
                            {left: "\\(", right: "\\)", display: false}
                        ]
                    }
                );
            </script></article><script>var disqus_shortname="musicalneuron";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents Â© 2019         <a href="mailto:mtsgrinberg@gmail.com">MatÃ­as Grinberg</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="../../assets/js/all-nocdn.js"></script><!-- Social buttons --><div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
 <a class="addthis_button_more">
<img src="https://www.searchpng.com/wp-content/uploads/2019/02/Share-icon-715x715.png" width="32" height="32" border="0" alt="Share" style="margin-right:9pt">
Share
</a>
 <ul>
<li>
<a class="addthis_button_facebook">Facebook</a>
 </li>
<li>
<a class="addthis_button_twitter">Twitter</a>
 </li>
<li>
<a class="addthis_button_linkedin">Linkedin</a>
 </li>
<li>
<a class="addthis_button_whatsapp">Whatsapp</a>
 </li>
</ul>
</div>
 <script src="https://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script><!-- End of social buttons --><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(2, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-151873836-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-151873836-1');
</script>
</body>
</html>
